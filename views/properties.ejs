<!DOCTYPE html>
<html lang="en">
<%- include('header'); -%>
<body>
<%- include('nav'); -%>

<main class="container properties-container">
  <aside class="filters-sidebar" id="filtersSidebar" aria-hidden="false">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <h3 id="filtersTitle" style="margin:0;">Filters</h3>
      <button id="filtersClose" class="btn btn-outline" style="margin-left:auto;">Close</button>
    </div>
    <form action="/properties" method="GET" id="filterForm">
      <div class="filter-group">
        <label for="city">City</label>
        <select name="city" id="city">
          <option value="">All Cities</option>
          <% cities.forEach(city => { %>
            <option value="<%= city.name %>" <%= currentCity === city.name ? 'selected' : '' %>>
              <%= city.name %>
            </option>
          <% }); %>
        </select>
      </div>

      <div class="filter-group">
        <label for="maxPrice">Max Price</label>
        <input type="range" id="maxPrice" name="maxPrice" min="2000" max="50000" value="50000">
        <span id="priceDisplay">₹50,000</span>
      </div>

      <div class="filter-group">
        <label>Property Type</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="propertyType" value="pg"> PG</label>
          <label><input type="checkbox" name="propertyType" value="hostel"> Hostel</label>
          <label><input type="checkbox" name="propertyType" value="flat"> Flat</label>
        </div>
      </div>

      <div class="filter-group">
        <label>Room Type</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="roomType" value="single"> Single</label>
          <label><input type="checkbox" name="roomType" value="double"> Double</label>
          <label><input type="checkbox" name="roomType" value="triple"> Triple</label>
          <label><input type="checkbox" name="roomType" value="shared"> Shared</label>
        </div>
      </div>

      <div class="filter-group">
        <label for="gender">Gender Preference</label>
        <select name="genderPreference" id="gender">
          <option value="">Any</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="any">Mixed</option>
        </select>
      </div>

      <button type="submit" class="btn-primary">Apply Filters</button>
    </form>
  </aside>

  <section class="properties-main">
    <button id="filtersToggle" class="filters-toggle-btn" aria-expanded="false" aria-controls="filtersSidebar">Show filters</button>
    <div class="properties-header">
      <h2><%= currentSearch ? `Search: "${currentSearch}"` : currentCity ? `Properties in ${currentCity}` : 'All Properties' %></h2>
      <p><%= properties.length %> properties found</p>
    </div>

    <% if (properties.length > 0) { %>
      <div class="properties-grid">
        <% properties.forEach(property => { %>
          <a href="/property/<%= property.id %>" class="property-card">
            <div class="property-image">
                  <% const firstImg = property.images && property.images.length ? property.images[0] : null; %>
                  <% if (firstImg) { %>
                    <% if (typeof firstImg === 'string') { %>
                      <img src="<%= firstImg %>" alt="<%= property.title %>">
                    <% } else { %>
                      <% const webpFormats = firstImg.formats ? firstImg.formats.filter(f => f.mime === 'image/webp').sort((a,b)=>a.width-b.width) : []; %>
                      <% const jpgFormats = firstImg.formats ? firstImg.formats.filter(f => f.mime === 'image/jpeg').sort((a,b)=>a.width-b.width) : []; %>
                      <picture>
                        <% if (webpFormats.length) { %>
                          <source type="image/webp" srcset="<%= webpFormats.map(f => `${f.src} ${f.width}w`).join(', ') %>">
                        <% } %>
                        <img src="<%= firstImg.default || (jpgFormats.length ? jpgFormats[jpgFormats.length-1].src : '/placeholder.jpg') %>" srcset="<%= jpgFormats.map(f => `${f.src} ${f.width}w`).join(', ') %>" sizes="(max-width:600px) 100vw, 33vw" alt="<%= property.title %>">
                      </picture>
                    <% } %>
                  <% } else { %>
                    <img src="/placeholder.jpg" alt="<%= property.title %>">
                  <% } %>
                  <span class="property-type"><%= property.propertyType %></span>
                </div>
            <div class="property-info">
              <h3><%= property.title %></h3>
              <p class="location"><%= property.area %>, <%= property.city %></p>
              <div class="amenities">
                <% if (property.amenities && property.amenities.length > 0) { %>
                  <% property.amenities.slice(0, 3).forEach(amenity => { %>
                    <span class="amenity-tag"><%= amenity %></span>
                  <% }); %>
                <% } else { %>
                  <span class="amenity-tag">Standard Amenities</span>
                <% } %>
              </div>
              <div class="property-footer">
                <span class="price">₹<%= property.price.toLocaleString('en-IN') %></span>
                <span class="rating">⭐ <%= property.rating || 4.5 %></span>
              </div>
            </div>
          </a>
        <% }); %>
      </div>
    <% } else { %>
      <p class="no-results">No properties found. Try adjusting your filters.</p>
    <% } %>
  </section>
</main>

<div id="filtersOverlay" class="filters-overlay" aria-hidden="true"></div>

<%- include('footer'); -%>

<script>
  const priceInput = document.querySelector('input[name="maxPrice"]');
  const priceDisplay = document.getElementById('priceDisplay');
  
  if (priceInput) {
    priceInput.addEventListener('input', (e) => {
      priceDisplay.textContent = '₹' + parseInt(e.target.value).toLocaleString('en-IN');
    });
  }

  // Mobile filters toggle
  const filtersToggle = document.getElementById('filtersToggle');
  const filtersSidebar = document.getElementById('filtersSidebar');
  const filtersClose = document.getElementById('filtersClose');
  // Mobile filters toggle is handled with overlay-aware setFilterOpen() below

  // overlay and close behavior
  const filtersOverlay = document.getElementById('filtersOverlay');
  if (filtersToggle && filtersSidebar && filtersOverlay) {
    let prevFocus = null;
    function setFilterOpen(open) {
      if (open) {
        filtersSidebar.classList.add('open');
        filtersOverlay.classList.add('show');
        filtersOverlay.setAttribute('aria-hidden', 'false');
        filtersSidebar.setAttribute('aria-hidden', 'false');
        filtersSidebar.setAttribute('role', 'dialog');
        filtersSidebar.setAttribute('aria-modal', 'true');
        filtersToggle.setAttribute('aria-expanded', 'true');
        document.body.classList.add('no-scroll');
        filtersToggle.textContent = 'Hide filters';
        prevFocus = document.activeElement;
        // set focus to first focusable element in filters
        const firstFocusable = filtersSidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (firstFocusable) firstFocusable.focus();
      } else {
        filtersSidebar.classList.remove('open');
        filtersOverlay.classList.remove('show');
        filtersOverlay.setAttribute('aria-hidden', 'true');
        filtersSidebar.setAttribute('aria-hidden', 'true');
        filtersSidebar.removeAttribute('role');
        filtersSidebar.removeAttribute('aria-modal');
        filtersToggle.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('no-scroll');
        filtersToggle.textContent = 'Show filters';
        if (prevFocus && typeof prevFocus.focus === 'function') prevFocus.focus();
      }
    }

    filtersToggle.addEventListener('click', function () {
      setFilterOpen(!filtersSidebar.classList.contains('open'));
      if (filtersSidebar.classList.contains('open')) filtersSidebar.scrollIntoView({ behavior: 'smooth' });
    });

    filtersOverlay.addEventListener('click', function () { setFilterOpen(false); });
    if (filtersClose) filtersClose.addEventListener('click', function () { setFilterOpen(false); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') setFilterOpen(false); });
    // Close sidebar when viewport grows to prevent it getting stuck as an overlay
    window.addEventListener('resize', function () { if (window.innerWidth > 768 && filtersSidebar.classList.contains('open')) setFilterOpen(false); });
  }
</script>
</body>
</html>
